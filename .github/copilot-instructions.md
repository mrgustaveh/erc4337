# Copilot Instructions for ERC-4337 Foundry Project

## Project Overview
This is a **Foundry-based Solidity smart contract project** implementing **ERC-4337 Account Abstraction** for smart contract wallets/accounts. The goal is to enable programmable accounts that can execute transactions via `UserOperation` objects through a decoupled flow, removing the need for externally-owned accounts (EOAs) as the transaction originator.

**Key ERC-4337 Concepts:**
- **Account Contract**: Custom smart contract acting as a wallet, deployed to a deterministic address
- **UserOperation**: Transaction intent bundled with signature and execution context (not a standard tx)
- **Bundler**: Off-chain service that aggregates UserOperations and sends to Entry Point
- **Entry Point**: Central contract that validates and executes UserOperations
- **Paymaster**: Optional contract sponsoring gas for UserOperations

The project uses **Forge** for testing, compilation, and deployment.

## Architecture & Key Files

### Core Structure
- **`src/`** - Smart contract implementations (Solidity ^0.8.13)
- **`test/`** - Test suite using Forge's `Test` contract from `forge-std`
- **`script/`** - Deployment scripts inheriting from `forge-std/Script.sol`
- **`lib/`** - External dependencies (managed by git submodules)
- **`out/`** - Compiled artifacts (autogenerated)

### Current Components
- **`SimpleAccount.sol`** - OpenZeppelin ERC-4337 account implementation with:
  - ECDSA signature validation via `SignerECDSAUpgradeable`
  - ERC-1271 signature validation interface
  - ERC1967 upgradeable proxy pattern for future improvements
  - ERC-7821 batched execution support
  - ERC-721 and ERC-1155 token holder capabilities
  - Initializable pattern for safe proxy deployment

- **`Account.t.sol`** - Comprehensive test suite covering:
  - Account initialization and signer setup
  - ETH receive functionality
  - ERC-1271 signature validation
  - Proxy deployment via ERC1967Proxy

- **`Account.s.sol`** - Deployment script with:
  - ERC1967Proxy deployment pattern
  - Signer address configuration (environment variable)
  - Implementation contract deployment
  - Initialization during proxy creation
  - Deployment logging

## Essential Workflows

### Building & Testing
```bash
forge build          # Compile all contracts
forge test           # Run full test suite (verbose with -vvv)
forge test --match-test test_Execute  # Run specific tests
forge snapshot       # Generate/update gas usage baseline
forge fmt            # Auto-format Solidity code
```

### Deployment
```bash
export SIGNER_ADDRESS="0x..."        # Account signer address (defaults to deployer)

forge script script/Account.s.sol:AccountScript \
  --rpc-url <RPC_URL> \
  --private-key <PRIVATE_KEY> \
  --broadcast
```

## Conventions & Patterns

### Test Naming
- **Unit tests**: `function test_<description>()` - e.g., `test_ExecuteSingleCall`
- **Setup**: Use `setUp()` for test contract initialization
- **Fixtures**: Helper contracts (SimpleTarget, SimpleNFT, SimpleERC1155) at end of test file

### UUPS Proxy Pattern
- All account contracts use ERC1967 proxy pattern with Initializable for safety
- Initialization in `initialize()` function (called during proxy creation)
- Upgrade authorization via `_authorizeUpgrade()` (restricted to entry point or self)

### Solidity Conventions
- **License**: MIT
- **Pragma**: ^0.8.27 (aligns with OpenZeppelin account contracts)
- **Imports**: Use named imports from `@openzeppelin/contracts` and `account-abstraction`
- **Contracts**: Inherit from OpenZeppelin's `Account` base class

## Critical Development Notes

1. **Dependencies**: Project uses OpenZeppelin Contracts v5.5+ with ERC-4337 account abstractions, account-abstraction (v0.9+), and openzeppelin-foundry-upgrades for proxy deployment.

2. **Test Assertions**: Use `assertEq()` and other assertions from the inherited `Test` contract.

3. **VM Cheatcodes**: Access via `vm.*` in scripts and tests (from `forge-std`).

4. **Upgrades Library**: `Upgrades.deployUUPSProxy()` handles both implementation deployment and proxy creation. Takes contract name as string, not address.

5. **Gas Optimization**: Use `forge snapshot` to track gas costs before/after optimizations.

## ERC-4337 Specific Patterns

### Account Contract Structure
Account contracts must:
- Implement `IAccount` interface with `validateUserOp()` and `execute*()` functions
- Follow signature validation best practices (avoid replay attacks across chains)
- Support deterministic deployment (e.g., via `CREATE2`) for predictable addresses
- Handle nonce tracking correctly (UserOps don't use standard tx nonce)

### UserOperation Flow
- **Bundler**: Collects UserOps from mempool
- **Entry Point**: Calls `validateUserOp()` â†’ checks signature, gas prefunding, nonce
- **Account**: Executes transaction logic in `execute()` (single call) or `executeBatch()` (multiple)
- **Paymaster** (optional): Provides gas sponsorship via `postOp()` callback

### Testing Strategy
- Test account validation logic with invalid signatures, replayed nonces, insufficient gas
- Test execution flows with mock Entry Point calls
- Test gas overhead of validation vs execution

## Key Files for Reference
- [foundry.toml](../foundry.toml) - Build configuration
- [src/Account.sol](../src/Account.sol) - ERC-4337 account contract
- [test/Account.t.sol](../test/Account.t.sol) - Account tests
- [script/Account.s.sol](../script/Account.s.sol) - Deployment script
